

# 准备

## Redis





## MySQL

用8，设置mysql的默认时区

![image-20200823003520638](优惠券项目.assets/image-20200823003520638.png)

## Kafka

### 消息系统

- 点对点消息系统
- 发布订阅消息系统

![image-20200823225848666](优惠券项目.assets/image-20200823225848666.png)

Kafka是一个分布式的发布订阅消息系统

![image-20200823231037874](优惠券项目.assets/image-20200823231037874.png)

- Topic：划分数据的类
- partition：每个Topic至少有一个partition。同一个partition里的数据是有序的，不同partition的数据可能是无序的，发送的消息可能进入p1或者p2
- Brokers：一个集群有多台服务器，一个服务器有一个Brokers，存储Topic中的数据，来维护负载均衡。
- producer：数据发布者，将消息发送到Topic，Brokers接收到消息后，把消息追加到partition中
- consumer：消费者，可以消费多个Topic中的数据。多个消费者可以组成消费者组。



### 安装

下载压缩包

打开config文件夹中server.properties

- broker.id：集群中唯一标识，这里默认就好
  - ![image-20200830002705532](优惠券项目.assets/image-20200830002705532.png)
- log.dirs：日志地址，根据需求自己修改
  - ![image-20200830002645796](优惠券项目.assets/image-20200830002645796.png)



![image-20200830002729653](优惠券项目.assets/image-20200830002729653.png)

- 先启动zk
- 启动kafka-server
- 创建topic
  - bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic first-kafka-topic
  - ![image-20200830003408049](优惠券项目.assets/image-20200830003408049.png)
- 查看topic
  - bin/kafka-topics.sh --list --zookeeper localhost:2181
- 启动消费者
  - bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic first-kafka-topic --from-beginning
- 启动生产者
  - bin/kafka-console-producer.sh --broker-list localhost:9092 --topic first-kafka-topic
  - ![image-20200830003918464](优惠券项目.assets/image-20200830003918464.png)



### 生产者消费者

![image-20200830004055871](优惠券项目.assets/image-20200830004055871.png)

消息中key的作用

- 提供描述消息的额外信息
- 决定消息写入哪个分区，相同key的消息肯定会分配到同一个分区



![image-20200830004400321](优惠券项目.assets/image-20200830004400321.png)

一个topic中的分区只会消费一次，不管消费者组中有多少个消费者

![image-20200830004643083](优惠券项目.assets/image-20200830004643083.png)

消费者组中消费者数量应该小于一个topic中分区的数量

![image-20200830004725152](优惠券项目.assets/image-20200830004725152.png)



### docker中安装



# Springboot相关



# SpringCloud

## Eureka

注册中心

包含两个组件

- Eureka Server
- Eureka Client
  - Service Provider：服务注册、心跳续约（告诉Server自己还活着）、下线（自己要下线，让Server删除自己的原信息）
  - Service Consumer：获取服务注册信息

Eureka用一个map管理原信息

~~~java
// 第一个key存储服务名称，第二个key存储实例名称，value表示实例的信息
ConcurrentHashMap<String,Map<String,Lease<InstanceInfo>>>
~~~



### 创建一个Eureka应用

引入依赖

~~~xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>imooc-coupon</artifactId>
        <groupId>com.imooc.coupon</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <modelVersion>4.0.0</modelVersion>

    <artifactId>coupon-eureka</artifactId>
    <version>1.0-SNAPSHOT</version>
    <packaging>jar</packaging>

    <!-- 模块名及描述信息 -->
    <name>coupon-eureka</name>
    <description>Spring Cloud Eureka For Coupon</description>

    <!-- eureka server: 提供服务发现与服务注册 -->
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
        </dependency>
    </dependencies>

    <!--
        SpringBoot的Maven插件, 能够以Maven的方式为应用提供SpringBoot的支持，可以将
        SpringBoot应用打包为可执行的jar或war文件, 然后以通常的方式运行SpringBoot应用
     -->
    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>


</project>
~~~



启动类，注意多了个Eureka的注解

~~~java
@EnableEurekaServer
@SpringBootApplication
public class EurekaApplication {

    public static void main(String[] args) {
        SpringApplication.run(EurekaApplication.class, args);
    }
}
~~~

配置application.yml

~~~yml
spring:
  application:
    name: coupon-eureka

server:
  port: 8000

eureka:
  instance:
    hostname: localhost
  client:
    # 标识是否从 Eureka Server 获取注册信息, 默认是 true. 如果这是一个单节点的 Eureka Server
    # 不需要同步其他节点的数据, 设置为 false
    fetch-registry: false
    # 是否将自己注册到 Eureka Server, 默认是 true. 由于当前应用是单节点的 Eureka Server
    # 需要设置为 false
    register-with-eureka: false
    # 设置 Eureka Server 所在的地址, 查询服务和注册服务都需要依赖这个地址
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
  server:
    enable-self-preservation: false
#    renewal-percent-threshold: 0.45
~~~



本地模拟多实例集群

配置文件

~~~yml
spring:
  application:
    name: coupon-eureka
  profiles: server1
server:
  port: 8000
eureka:
  instance:
  # eureka不允许单机多实例，同一个ip不通过，这里用用host
    hostname: server1
    prefer-ip-address: false
  client:
    service-url:
      defaultZone: http://server2:8001/eureka/,http://server3:8002/eureka/

---
spring:
  application:
    name: coupon-eureka
  profiles: server2
server:
  port: 8001
eureka:
  instance:
    hostname: server2
    prefer-ip-address: false
  client:
    service-url:
      defaultZone: http://server1:8000/eureka/,http://server3:8002/eureka/

---
spring:
  application:
    name: coupon-eureka
  profiles: server3
server:
  port: 8002
eureka:
  instance:
    hostname: server3
    prefer-ip-address: false
  client:
    service-url:
      defaultZone: http://server1:8000/eureka/,http://server2:8001/eureka/

~~~

maven打包

~~~bash
mvn clean package -Dmaven.test.skip=true -U
~~~

进入项目target，找到eureka的jar包，根据不同配置启动三个eureka

~~~bash
java -jar coupon-eureka-1.0-SNAPSHOT.jar --spring.profiles.active=server1
java -jar coupon-eureka-1.0-SNAPSHOT.jar --spring.profiles.active=server2
java -jar coupon-eureka-1.0-SNAPSHOT.jar --spring.profiles.active=server3

~~~



